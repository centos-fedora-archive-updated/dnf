From 5d893b74b30b0c4b3b97591abfbd92cccb1d97ae Mon Sep 17 00:00:00 2001
From: Jaroslav Mracek <jmracek@redhat.com>
Date: Tue, 3 Sep 2019 11:01:51 +0200
Subject: [PATCH] Keep installed packages in upgrade job (RhBug:1728252,1644241,1741381)

In combination with marking of job as TARGETED it prevents from
reinstalling of modified packages with same NEVRA.

https://bugzilla.redhat.com/show_bug.cgi?id=1728252
https://bugzilla.redhat.com/show_bug.cgi?id=1644241
https://bugzilla.redhat.com/show_bug.cgi?id=1741381

Closes: #1474
Approved by: m-blaha
---
 dnf/base.py               | 3 ---
 dnf/module/module_base.py | 2 +-
 2 files changed, 1 insertion(+), 4 deletions(-)

diff --git a/dnf/base.py b/dnf/base.py
index 418f472..32d2ed1 100644
--- a/dnf/base.py
+++ b/dnf/base.py
@@ -1966,9 +1966,6 @@ class Base(object):
                 obsoletes=q.installed().union(q.upgrades()))
             # add obsoletes into transaction
             q = q.union(obsoletes)
-        # provide only available packages to solver otherwise selection of available
-        # possibilities will be ignored
-        q = q.available()
         if reponame is not None:
             q.filterm(reponame=reponame)
         q = self._merge_update_filters(q, pkg_spec=pkg_spec)
diff --git a/dnf/module/module_base.py b/dnf/module/module_base.py
index 6ec1c14..7078af3 100644
--- a/dnf/module/module_base.py
+++ b/dnf/module/module_base.py
@@ -171,7 +171,7 @@ class ModuleBase(object):
 
             if not upgrade_package_set:
                 logger.error(_("Unable to match profile in argument {}").format(spec))
-            query = self.base.sack.query().available().filterm(name=upgrade_package_set)
+            query = self.base.sack.query().filterm(name=upgrade_package_set)
             if query:
                 sltr = dnf.selector.Selector(self.base.sack)
                 sltr.set(pkg=query)
--
libgit2 0.28.2

